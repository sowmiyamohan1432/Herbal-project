<div class="container">
  <h2>{{ isEditing ? 'Edit Product' : 'Add Product' }}</h2>
  
  <div *ngIf="isLoading" class="loading-overlay">
    <div class="spinner"></div>
  </div>

  <form (ngSubmit)="addProduct()" #productForm="ngForm">

    <!-- Basic Information Section -->
    <div class="container">
      <div class="form-row">
        <div class="form-group">
          <label class="required">Product Name:</label>
          <input type="text" placeholder="Product Name" 
                 [(ngModel)]="product.productName" name="productName" 
                 (input)="onProductNameChange()" required>
        </div>
        <div class="form-group">
          <label>SKU: <span class="info-icon" title="Stock Keeping Unit">i</span></label>
          <input type="text" placeholder="SKU" 
                 [(ngModel)]="product.sku" name="sku" 
                 [readonly]="isGeneratingSku || product.sku" required>
          <span *ngIf="isGeneratingSku" class="generating-sku">Generating SKU...</span>
        </div>
      </div>

      <div class="form-group">
        <label class="required">Barcode Type:</label>
        <select [(ngModel)]="product.barcodeType" name="barcodeType" required>
          <option>Code 128 (C128)</option>
          <option>Code 39</option>
          <option>EAN-13</option>
          <option>UPC-A</option>
        </select>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="required">Unit:</label>
          <div class="unit-select-container">
            <select [(ngModel)]="product.unit" name="unit" required>
              <option value="">Please Select</option>
              <option *ngFor="let unit of units" [value]="unit.name">
                {{ unit.name }} ({{ unit.shortName }})
              </option>
            </select>
            <button type="button" class="btn-add">+</button>
          </div>
        </div>
        <div class="form-group">
          <label>Brand:</label>
          <div class="brand-select-container">
            <select [(ngModel)]="product.brand" name="brand">
              <option value="">Please Select</option>
              <option *ngFor="let brand of brands" [value]="brand.name">
                {{ brand.name }}
              </option>
            </select>
            <button type="button" class="btn-add">+</button>
          </div>
        </div>
        <div class="form-group">
          <label>Category:</label>
          <select [(ngModel)]="product.category" name="category" (change)="onCategoryChange()">
            <option value="">Please Select</option>
            <option *ngFor="let category of categories" [value]="category.name">
              {{ category.name }}
            </option>
          </select>
        </div>
      </div>

      <div class="form-group" *ngIf="filteredSubCategories.length > 0">
        <label>Sub Category:</label>
        <select [(ngModel)]="product.subCategory" name="subCategory">
          <option value="">Please Select</option>
          <option *ngFor="let subCat of filteredSubCategories" [value]="subCat.name">
            {{ subCat.name }}
          </option>
        </select>
      </div>

      <!-- Inventory Management Section -->
      <div class="form-row">
        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="manageStock" [(ngModel)]="product.manageStock" name="manageStock">
            <label for="manageStock">Manage Stock? <span class="info-icon" title="Enable stock management">i</span></label>
          </div>
          <div class="hint-text">Enable stock management at product level</div>
        </div>
        <div class="form-group" *ngIf="product.manageStock">
          <label>Alert quantity: <span class="info-icon" title="Low stock alert level">i</span></label>
          <input type="number" placeholder="Alert quantity" 
                 [(ngModel)]="product.alertQuantity" name="alertQuantity">
        </div>
      </div>

      <!-- Product Description Section -->
      <div class="form-row">
        <div class="form-group full-width">
          <label>Product Description:</label>
          <div class="text-editor">
            <textarea [(ngModel)]="product.productDescription" name="productDescription"></textarea>
          </div>
        </div>
      </div>

      <!-- File Uploads Section -->
      <div class="form-row">
        <div class="form-group">
          <label>Product image:</label>
          <div class="file-upload">
            <input type="file" id="productImage" (change)="onFileSelected($event, 'image')" accept="image/*">
            <label for="productImage" class="btn btn-primary">Browse...</label>
            <div class="file-info">{{ product.productImage?.name || 'No file chosen' }}</div>
          </div>
          <div class="file-requirements">
            Max File size: 5MB<br>
            Aspect ratio should be 1:1
          </div>
        </div>
        <div class="form-group">
          <label>Product brochure:</label>
          <div class="file-upload">
            <input type="file" id="productBrochure" (change)="onFileSelected($event, 'brochure')" 
                   accept=".pdf,.csv,.zip,.doc,.docx,.jpeg,.jpg,.png">
            <label for="productBrochure" class="btn btn-secondary">Choose File</label>
            <div class="file-info">{{ product.productBrochure?.name || 'No file chosen' }}</div>
          </div>
          <div class="file-requirements">
            Max File size: 5MB<br>
            Allowed: .pdf, .csv, .zip, .doc, .docx, .jpeg, .jpg, .png
          </div>
        </div>
      </div>
    </div>

    <!-- Additional Information Section -->
    <div class="container">
      <div class="form-row">
        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="enableDescription" [(ngModel)]="product.enableProductDescription" name="enableProductDescription">
            <label for="enableDescription">Enable Product description, IMEI or Serial Number <span class="info-icon">i</span></label>
          </div>
        </div>
        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="notForSelling" [(ngModel)]="product.notForSelling" name="notForSelling">
            <label for="notForSelling">Not for selling <span class="info-icon">i</span></label>
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Weight (kg):</label>
          <input type="number" step="0.01" placeholder="Weight" 
                 [(ngModel)]="product.weight" name="weight">
        </div>
        <div class="form-group">
          <label>Preparation time (minutes):</label>
          <input type="number" placeholder="Preparation time" 
                 [(ngModel)]="product.preparationTime" name="preparationTime">
        </div>
      </div>
    </div>

    <!-- Pricing Information Section -->
    <div class="container">
      <div class="form-row">
        <div class="form-group">
          <label>Applicable Tax:</label>
          <select [(ngModel)]="product.applicableTax" name="applicableTax">
            <option>None</option>
          </select>
        </div>
        <div class="form-group">
          <label class="required">Selling Price Tax Type:</label>
          <select [(ngModel)]="product.sellingPriceTaxType" name="sellingPriceTaxType" required>
            <option>Exclusive</option>
            <option>Inclusive</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="required">Product Type:</label>
          <select [(ngModel)]="product.productType" name="productType" required>
            <option>Single</option>
            <option>Variant</option>
          </select>
        </div>
      </div>

      <table class="pricing-table">
        <thead>
          <tr>
            <th>Default Purchase Price</th>
            <th>Margin (%)</th>
            <th>Default Selling Price</th>
            <th>Product image</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>
              <label class="required">Exc. tax:</label>
              <input type="number" step="0.01" placeholder="Exc. tax" 
                     [(ngModel)]="product.defaultPurchasePriceExcTax" 
                     name="defaultPurchasePriceExcTax"
                     (change)="calculateSellingPrice()"
                     required>
            </td>
            <td>
              <input type="number" step="0.01" placeholder="25.00" 
                     [(ngModel)]="product.marginPercentage" 
                     name="marginPercentage"
                     (change)="calculateSellingPrice()">
            </td>
            <td>
              <label>Exc. Tax</label>
              <input type="number" step="0.01" placeholder="Exc. tax" 
                     [(ngModel)]="product.defaultSellingPriceExcTax" 
                     name="defaultSellingPriceExcTax">
            </td>
            <td rowspan="2">
              <label>Product image:</label>
              <div class="file-upload">
                <input type="file" id="pricingImage" (change)="onFileSelected($event, 'image')" accept="image/*">
                <label for="pricingImage" class="btn btn-secondary">Choose Files</label>
                <div class="file-info">{{ product.productImage?.name || 'No file chosen' }}</div>
              </div>
            </td>
          </tr>
          <tr>
            <td>
              <label>Inc. tax:</label>
              <input type="number" step="0.01" placeholder="Inc. tax" 
                     [(ngModel)]="product.defaultPurchasePriceIncTax" 
                     name="defaultPurchasePriceIncTax">
            </td>
            <td></td>
            <td></td>
          </tr>
        </tbody>
      </table>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary" [disabled]="isLoading">
          {{ isEditing ? 'Update Product' : 'Save Product' }}
        </button>
        <button type="button" class="btn btn-secondary" [disabled]="isLoading" (click)="resetForm()">
          Cancel
        </button>
        <button *ngIf="isEditing" type="button" class="btn btn-danger" [disabled]="isLoading" 
                (click)="deleteProduct(product.id)">
          Delete Product
        </button>
      </div>
    </div>
  </form>

  <!-- Products List Section -->
  <div class="products-list-container" *ngIf="products.length > 0">
    <h3>Product List (Real-time Updates)</h3>
    <div class="table-responsive">
      <table class="products-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>SKU</th>
            <th>Category</th>
            <th>Price</th>
            <th>Stock</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let product of products">
            <td>{{ product.productName || 'N/A' }}</td>
            <td>{{ product.sku || 'N/A' }}</td>
            <td>{{ product.category || 'N/A' }}</td>
            <td>{{ product.defaultSellingPriceExcTax | currency:'USD':'symbol':'1.2-2' }}</td>
            <td>{{ product.manageStock ? (product.alertQuantity || 0) : 'N/A' }}</td>
            <td class="actions">
              <button class="btn-edit" (click)="editProduct(product)">Edit</button>
              <button class="btn-delete" (click)="deleteProduct(product.id)">Delete</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="footer">
    HYBRID CRM - v6.2 | Copyright © 2025 All rights reserved.
  </div>
</div>
